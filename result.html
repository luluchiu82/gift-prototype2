<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¿ƒæ„å¡ç‰‡ç”Ÿæˆçµæœ</title>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
<style>
body {
  font-family: "Noto Sans TC", sans-serif;
  background: #f7f7f7;
  text-align: center;
  padding: 2em;
}
#card {
  width: 90%;
  max-width: 400px;
  margin: auto;
  background: #fff;
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
#card img {
  width: 80px;
  height: 80px;
  border-radius: 12px;
  margin: 5px;
  object-fit: cover;
}
#images {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-bottom: 10px;
}
#title {
  font-size: 1.2rem;
  margin-bottom: 10px;
}
#message {
  white-space: pre-wrap;
  font-size: 1rem;
  color: #333;
  line-height: 1.5;
}
#recipient {
  font-size: 0.9rem;
  color: #888;
  margin-top: 10px;
}
#qrcode-container {
  margin-top: 15px;
  display: flex;
  justify-content: center;
}
#preview {
  margin-top: 20px;
}
.btn {
  padding: 10px 20px;
  margin-top: 10px;
  border: none;
  border-radius: 10px;
  background: #6fb27b;
  color: #fff;
  cursor: pointer;
}
.btn:hover {
  background: #5b9968;
}
</style>
</head>
<body>

<h2>ğŸ å¿ƒæ„å¡ç‰‡ç”Ÿæˆ</h2>

<div id="card">
  <div id="images"></div>
  <div id="title"></div>
  <div id="message"></div>
  <div id="recipient"></div>
  <div id="qrcode-container"></div>
</div>

<div id="result">
  <button class="btn" onclick="generateCard()">ç”Ÿæˆåœ–ç‰‡</button>
  <div id="preview"></div>
</div>

<script>
// ===== å¾ sessionStorage è®€å–ä½¿ç”¨è€…è³‡æ–™ =====
const drink = sessionStorage.getItem('drink') || "";
const drinkImg = sessionStorage.getItem('drinkImg') || "";
const gift = sessionStorage.getItem('gift') || "";
const giftImg = sessionStorage.getItem('giftImg') || "";
const recipientName = sessionStorage.getItem('recipient') || "";
const messageText = sessionStorage.getItem('message') || "";

// æ›´æ–°å¡ç‰‡å…§å®¹
document.getElementById("images").innerHTML = `
  ${drinkImg ? `<img src="${drinkImg}" alt="${drink}">` : ""}
  ${giftImg ? `<img src="${giftImg}" alt="${gift}">` : ""}
`;
document.getElementById("title").textContent = `${drink} ${gift ? "ï¼‹" + gift : ""}`;
document.getElementById("message").textContent = messageText;
document.getElementById("recipient").textContent = recipientName ? `â€” ${recipientName}` : "";

// ===== ç”Ÿæˆå¡ç‰‡åœ–ç‰‡èˆ‡åˆ†äº« =====
function generateCard(){
  const qrContainer = document.getElementById("qrcode-container");
  qrContainer.innerHTML = "";

  // QR code å…§å®¹å¯æ”¹æˆä»˜æ¬¾ç”¨æˆ–ä»»æ„æ–‡å­—
  new QRCode(qrContainer, {
    text: "ä»˜æ¬¾ç”¨ QR code",
    width: 128,
    height: 128
  });

  // ç­‰ä¸€å€‹å°æ™‚é–“è®“ QR code æ¸²æŸ“
  setTimeout(() => {
    html2canvas(document.getElementById("card"), { scale: 2 }).then(canvas => {
      const preview = document.getElementById("preview");
      preview.innerHTML = "";

      // é¡¯ç¤ºç”Ÿæˆåœ–ç‰‡
      const img = document.createElement("img");
      img.src = canvas.toDataURL("image/png");
      img.style.maxWidth = "90%";
      img.style.borderRadius = "12px";
      preview.appendChild(img);

      // åˆ†äº«æŒ‰éˆ•
      const shareBtn = document.createElement("button");
      shareBtn.className = "btn";
      shareBtn.textContent = "åˆ†äº«å¡ç‰‡";
      shareBtn.onclick = () => {
        if (navigator.share) {
          navigator.share({ files: [dataURLtoFile(img.src, "gift-card.png")], title:"å¿ƒæ„å¡ç‰‡" })
            .catch(err => console.log(err));
        } else {
          alert("ä½ çš„è£ç½®ä¸æ”¯æ´ç›´æ¥åˆ†äº«ï¼Œè«‹é•·æŒ‰åœ–ç‰‡å¦å­˜ã€‚");
        }
      };
      preview.appendChild(shareBtn);
    });
  }, 200);
}

// ===== helper: dataURL è½‰ File =====
function dataURLtoFile(dataurl, filename) {
  const arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
        bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
  while(n--){ u8arr[n] = bstr.charCodeAt(n); }
  return new File([u8arr], filename, {type:mime});
}
</script>

</body>
</html>
